<!DOCTYPE html>
<html>
<head>
  <title>Whisper Transcriber</title>
  <style>
    body { font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif; background:#f5f7fa; margin:0; color:#222; }
    h1 { text-align:center; margin:30px 0 10px; font-weight:600; }
    .container { max-width:900px; margin:0 auto 80px; padding:0 20px; }
    #drop-area { border:2px dashed #5b6b7a; padding:46px 30px; border-radius:18px; background:#fff; text-align:center; cursor:pointer; transition: border-color .25s, background .25s; }
    #drop-area.hover { border-color:#2563eb; background:#eef5ff; }
    #drop-area strong { display:block; font-size:17px; margin-bottom:6px; }
    #meta, #controls, #status-wrap, #logs-wrap { margin-top:28px; }
    #meta table { width:100%; border-collapse:collapse; background:#fff; border-radius:12px; overflow:hidden; }
    #meta th, #meta td { padding:10px 14px; text-align:left; font-size:14px; }
    #meta th { background:#1e293b; color:#fff; width:160px; font-weight:500; }
    #meta td { background:#f8fafc; }
    .badge { display:inline-block; padding:2px 8px; font-size:12px; border-radius:999px; background:#334155; color:#fff; }
    #controls button { background:#2563eb; border:none; color:#fff; padding:10px 18px; margin-right:10px; border-radius:10px; font-size:14px; cursor:pointer; font-weight:500; box-shadow:0 2px 4px rgba(0,0,0,.1); transition: background .2s, transform .15s; }
    #controls button.secondary { background:#64748b; }
    #controls button.danger { background:#dc2626; }
    #controls button.warning { background:#f59e0b; }
    #controls button:disabled { opacity:.45; cursor:not-allowed; }
    #controls button:not(:disabled):active { transform:translateY(1px); }
    #progress { width:100%; height:14px; border-radius:7px; background:#e2e8f0; overflow:hidden; box-shadow: inset 0 1px 2px rgba(0,0,0,.12); }
    #progress-bar { height:100%; width:0%; background:linear-gradient(90deg,#2563eb,#06b6d4); transition:width .35s; }
    #status { font-size:14px; font-weight:500; margin-top:12px; }
    #logs { background:#0f172a; color:#e2e8f0; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size:12.5px; padding:14px 16px 70px; border-radius:14px; height:280px; overflow:auto; line-height:1.5; position:relative; box-shadow:0 4px 16px -4px rgba(15,23,42,.35); }
    #logs .line { opacity:.92; }
    #logs .ts { color:#64748b; margin-right:6px; }
    footer { text-align:center; font-size:12px; padding:34px 0 40px; color:#64748b; }
    .hidden { display:none !important; }
    .fade-in { animation:fade .5s ease; }
    @keyframes fade { from {opacity:0; transform: translateY(4px);} to {opacity:1; transform:none;} }
  </style>
</head>
<body>
  <div class="container">
  <h1>Whisper Transcriber</h1>
  <div id="gpu-banner" style="display:none; text-align:center; font-size:12px; margin-top:-4px; color:#065f46; font-weight:500;"></div>
  <div id="drop-area" class="fade-in">
      <strong>Upload Audio</strong>
      <span style="font-size:13px; color:#475569;">Drag & drop or click to select (mp3, wav, m4a, mp4, aac, flac, ogg, wma, webm)</span>
    </div>
    <form id="upload-form" enctype="multipart/form-data" class="hidden">
      <input type="file" id="file-input" name="file" accept="audio/*" />
    </form>

    <div id="meta" class="hidden fade-in"></div>

    <div id="jobs-board" class="hidden fade-in" style="margin-top:34px;">
      <h3 style="margin:0 0 10px; font-size:15px; font-weight:600; color:#334155; display:flex; align-items:center; gap:8px;">Recent Jobs <button id="refresh-jobs" style="background:#64748b; color:#fff; border:none; padding:4px 10px; border-radius:8px; font-size:12px; cursor:pointer;">Refresh</button></h3>
      <div style="background:#fff; border:1px solid #e2e8f0; border-radius:12px; overflow:hidden;">
        <table style="width:100%; border-collapse:collapse; font-size:13px;">
          <thead style="background:#1e293b; color:#fff;">
            <tr><th style="text-align:left; padding:8px 10px;">ID</th><th style="text-align:left; padding:8px 10px;">File</th><th style="text-align:left; padding:8px 10px;">Model</th><th style="text-align:left; padding:8px 10px;">Status</th><th style="text-align:left; padding:8px 10px;">Progress</th></tr>
          </thead>
          <tbody id="jobs-tbody"></tbody>
        </table>
      </div>
    </div>

    <div id="controls" class="hidden fade-in">
      <div style="margin:22px 0 16px; display:flex; gap:12px; flex-wrap:wrap;">
        <button id="btn-start">Start Transcription</button>
        <button id="btn-cancel" class="danger" disabled>Cancel</button>
        <button id="btn-download" class="secondary" disabled>Download Text</button>
        <button id="btn-reset" class="secondary" disabled>Reset</button>
        <button id="btn-clear-cache" class="warning" title="Clear all uploaded audio files and cached data from memory">Clear All Files</button>
      </div>
  <div id="option-panel" style="background:#fff; border:1px solid #e2e8f0; padding:16px 18px 10px; border-radius:14px; margin-bottom:18px; box-shadow:0 2px 6px -2px rgba(0,0,0,.08); position:relative;">
        <div style="display:flex; gap:18px; flex-wrap:wrap; align-items:flex-end;">
          <div style="flex:1 1 160px; min-width:160px;">
            <label style="font-size:12px; font-weight:600; color:#475569; letter-spacing:.5px;">Model <span class="help" title="Select a Whisper size. Larger = slower + more accurate.">?</span></label>
            <select id="model-select" style="width:100%; padding:8px 10px; border:1px solid #cbd5e1; border-radius:10px; font-size:14px; background:#f8fafc;"></select>
          </div>
          <div style="flex:1 1 110px; min-width:110px;">
            <label style="font-size:12px; font-weight:600; color:#475569;">Task <span class="help" title="transcribe = original language, translate = English output.">?</span></label>
            <select id="task-select" style="width:100%; padding:8px 10px; border:1px solid #cbd5e1; border-radius:10px; font-size:14px; background:#f8fafc;">
              <option value="transcribe">transcribe</option>
              <option value="translate">translate</option>
            </select>
          </div>
          <div style="flex:1 1 110px; min-width:110px;">
            <label style="font-size:12px; font-weight:600; color:#475569;">Temperature <span class="help" title="Randomness (0 = deterministic). Use >0 only if decoding gets stuck.">?</span></label>
            <input id="opt-temperature" type="number" step="0.1" min="0" max="1" style="width:100%; padding:8px 10px; border:1px solid #cbd5e1; border-radius:10px; font-size:14px; background:#f8fafc;" />
          </div>
          <div style="flex:1 1 110px; min-width:110px;">
            <label style="font-size:12px; font-weight:600; color:#475569;">Beam Size <span class="help" title="Beam search width (higher = slower, sometimes better accuracy).">?</span></label>
            <input id="opt-beam" type="number" min="1" max="20" step="1" style="width:100%; padding:8px 10px; border:1px solid #cbd5e1; border-radius:10px; font-size:14px; background:#f8fafc;" />
          </div>
          <div style="flex:1 1 110px; min-width:110px;">
            <label style="font-size:12px; font-weight:600; color:#475569;">Best Of <span class="help" title="Sample N candidates (uses temperature) then keep best log-prob. Increases quality + latency.">?</span></label>
            <input id="opt-bestof" type="number" min="1" max="20" step="1" style="width:100%; padding:8px 10px; border:1px solid #cbd5e1; border-radius:10px; font-size:14px; background:#f8fafc;" />
          </div>
          <div style="flex:1 1 140px; min-width:140px;">
            <label style="font-size:12px; font-weight:600; color:#475569;">Language (opt) <span class="help" title="Force language code (ISO 639-1, e.g. en, es). Leave blank to auto-detect.">?</span></label>
            <input id="opt-language" type="text" placeholder="auto" style="width:100%; padding:8px 10px; border:1px solid #cbd5e1; border-radius:10px; font-size:14px; background:#f8fafc;" />
          </div>
        </div>
        <div style="margin-top:10px; font-size:11.5px; color:#64748b; line-height:1.4;">
          Adjust decoding parameters. Hover ? for explanations. For fastest runs: temperature 0, beam 1, best_of 1. Increase beam/best_of for accuracy (slower).
          <div id="model-hint" style="margin-top:6px; font-size:11px; color:#475569;"></div>
        </div>
      </div>
  <div id="progress" class="hidden"><div id="progress-bar"></div></div>
  <div id="status"></div>
  <div id="eta" style="font-size:12px; color:#475569; margin-top:4px;"></div>
    </div>

    <div id="logs-wrap" class="hidden fade-in" style="margin-top:34px;">
      <h3 style="margin:0 0 10px; font-size:15px; font-weight:600; color:#334155;">Live Logs</h3>
      <div id="logs"></div>
    </div>
  </div>
  <footer>Made by <a href="https://gopichand.me" target="_blank" rel="noopener">Gopichand Busam</a> – Open Source | Local processing using Whisper (<span id="model-tag" class="badge"></span>)</footer>
  <script>
    const dropArea = document.getElementById('drop-area');
    const fileInput = document.getElementById('file-input');
    const metaDiv = document.getElementById('meta');
    const statusDiv = document.getElementById('status');
    const progress = document.getElementById('progress');
    const progressBar = document.getElementById('progress-bar');
    const logsEl = document.getElementById('logs');
    const controls = document.getElementById('controls');
    const logsWrap = document.getElementById('logs-wrap');
    const startBtn = document.getElementById('btn-start');
    const cancelBtn = document.getElementById('btn-cancel');
    const dlBtn = document.getElementById('btn-download');
    const resetBtn = document.getElementById('btn-reset');
    const clearCacheBtn = document.getElementById('btn-clear-cache');
    document.getElementById('model-tag').textContent = 'loading';

    const modelSelect = document.getElementById('model-select');
    const taskSelect = document.getElementById('task-select');
    const tempInput = document.getElementById('opt-temperature');
    const beamInput = document.getElementById('opt-beam');
    const bestOfInput = document.getElementById('opt-bestof');
    const langInput = document.getElementById('opt-language');

    let modelMeta = {memory:{}, rtf:{}};
    let gpuInfo = null;
    fetch('/health').then(r=>r.json()).then(d=>{
      document.getElementById('model-tag').textContent = d.default_model;
      modelMeta.memory = d.model_memory_gb || {};
      modelMeta.rtf = d.model_rtf_factors_active || {};
      gpuInfo = d.gpu || null;
      if (gpuInfo && gpuInfo.available){
        const banner = document.getElementById('gpu-banner');
        banner.style.display='block';
        banner.textContent = 'GPU Acceleration Active: '+(gpuInfo.name||'GPU');
      }
      d.supported_models.forEach(m => {
        const opt=document.createElement('option'); opt.value=m; opt.textContent=m + (m===d.default_model?' (default)':''); modelSelect.appendChild(opt);
      });
      // Restore from localStorage or set defaults
      const saved = JSON.parse(localStorage.getItem('whisperSettings')||'{}');
      modelSelect.value = saved.model_size || d.suggested_model || d.default_model;
      taskSelect.value = saved.task || 'transcribe';
      tempInput.value = saved.temperature ?? d.default_options.temperature;
      beamInput.value = saved.beam_size ?? d.default_options.beam_size;
      bestOfInput.value = saved.best_of ?? d.default_options.best_of;
      langInput.value = saved.language || '';
      updateModelHint();
    }).catch(()=>{document.getElementById('model-tag').textContent='?';});

    function persistSettings(){
      const payload = {
        model_size: modelSelect.value,
        task: taskSelect.value,
        temperature: parseFloat(tempInput.value||'0'),
        beam_size: parseInt(beamInput.value||'5'),
        best_of: parseInt(bestOfInput.value||'5'),
        language: (langInput.value||'').trim(),
      };
      localStorage.setItem('whisperSettings', JSON.stringify(payload));
    }

    [modelSelect, taskSelect, tempInput, beamInput, bestOfInput, langInput].forEach(el=>{
      el.addEventListener('change', ()=>{persistSettings(); updateModelHint();});
      el.addEventListener('input', ()=>{persistSettings(); updateModelHint();});
    });

    function updateModelHint(){
      const m = modelSelect.value;
      const mem = modelMeta.memory[m];
      const rtf = modelMeta.rtf[m];
      let txt = '';
      if (mem) txt += `Approx RAM: ${mem.toFixed?mem.toFixed(1):mem} GB. `;
      if (rtf) txt += `Est. speed factor: ~${rtf}x audio length.`;
      document.getElementById('model-hint').textContent = txt;
    }

    let currentJob = null;
    let logOffset = 0;
    let pollTimer = null;
    let logTimer = null;

    const prevent = e => { e.preventDefault(); e.stopPropagation(); };
    ['dragenter','dragover','dragleave','drop'].forEach(ev=>{
      dropArea.addEventListener(ev, prevent);
    });
    dropArea.addEventListener('dragover', ()=> dropArea.classList.add('hover'));
    dropArea.addEventListener('dragleave', ()=> dropArea.classList.remove('hover'));
    dropArea.addEventListener('drop', e => {
      dropArea.classList.remove('hover');
      const file = e.dataTransfer.files[0];
      if (file) handleFile(file);
    });
    dropArea.addEventListener('click', ()=> fileInput.click());
    fileInput.addEventListener('change', e => {
      const file = e.target.files[0];
      if (file) handleFile(file);
    });

    function bytesToHuman(bytes){
      if (bytes === 0) return '0 B';
      const k = 1024; const sizes = ['B','KB','MB','GB'];
      const i = Math.floor(Math.log(bytes)/Math.log(k));
      return (bytes/Math.pow(k,i)).toFixed(2)+' '+sizes[i];
    }

    function secondsToHuman(sec){
      const s = Math.round(sec);
      const m = Math.floor(s/60); const rem = s%60;
      return (m>0?m+'m ':'')+rem+'s';
    }

    function setStatus(msg, tone='normal') {
      statusDiv.textContent = msg;
      statusDiv.style.color = tone==='error' ? '#dc2626' : tone==='ok'? '#065f46':'#334155';
    }

    function handleFile(file){
      resetUI(false);
      setStatus('Uploading '+file.name+' ...');
      uploadFile(file);
    }

    function uploadFile(file){
      const formData = new FormData();
      formData.append('file', file);
      progress.classList.remove('hidden');
      const xhr = new XMLHttpRequest();
      xhr.open('POST','/upload');
      xhr.upload.onprogress = e => {
        if (e.lengthComputable){
          const pct = Math.round(e.loaded/e.total*100);
          progressBar.style.width = pct+'%';
        }
      };
      xhr.onload = () => {
        if (xhr.status === 201){
          const data = JSON.parse(xhr.responseText);
          currentJob = data.job_id;
          progressBar.style.width = '100%';
          showMeta({
            filename: file.name,
            size: data.size_bytes,
            duration: data.duration_seconds,
            recommended: data.recommended_model,
            analysis: data.analysis
          });
          // Initially in preparing state; UI will poll until ready
          setStatus('Preparing audio ...');
          enableControls('preparing');
          startLogPolling();
          pollStatus();
        } else {
          try { setStatus('Upload failed: '+JSON.parse(xhr.responseText).error,'error'); } catch { setStatus('Upload failed','error'); }
        }
      };
      xhr.onerror = () => setStatus('Network error during upload','error');
      xhr.send(formData);
    }

    function showMeta(info){
      let rows = `<tr><th>Filename</th><td>${info.filename}</td></tr>`+
                 `<tr><th>Size</th><td>${bytesToHuman(info.size)}</td></tr>`+
                 (info.duration?`<tr><th>Duration</th><td>${secondsToHuman(info.duration)}</td></tr>`:'')+
                 (info.recommended?`<tr><th>Suggested Model</th><td>${info.recommended}</td></tr>`:'')+
                 `<tr><th>Status</th><td id="meta-status" class="badge">ready</td></tr>`+
                 `<tr><th>Job ID</th><td><code>${currentJob}</code></td></tr>`;
      let html = `<table><tbody>${rows}</tbody></table>`;
      if (info.analysis && info.analysis.length){
        const body = info.analysis.map(a=>{
          const eta = (typeof a.eta_seconds==='number')?secondsToHuman(a.eta_seconds):'?';
          const mem = a.memory_gb!=null? a.memory_gb.toFixed? a.memory_gb.toFixed(1)+' GB':a.memory_gb+' GB':'?';
          return `<tr><td>${a.model}</td><td>${eta}</td><td>${mem}</td></tr>`;
        }).join('');
        html += `<div style="overflow-x:auto; margin-top:10px;"><table><thead><tr><th>Model</th><th>ETA</th><th>RAM</th></tr></thead><tbody>${body}</tbody></table></div>`;
      }
      metaDiv.innerHTML = html;
      metaDiv.classList.remove('hidden');
      controls.classList.remove('hidden');
      logsWrap.classList.remove('hidden');
    }

    function enableControls(state){
      if (state==='ready'){
        startBtn.disabled=false; cancelBtn.disabled=true; dlBtn.disabled=true; resetBtn.disabled=false; clearCacheBtn.disabled=false;
      } else if (state==='processing'){
        startBtn.disabled=true; cancelBtn.disabled=false; dlBtn.disabled=true; resetBtn.disabled=true; clearCacheBtn.disabled=true;
      } else if (state==='done'){
        startBtn.disabled=true; cancelBtn.disabled=true; dlBtn.disabled=false; resetBtn.disabled=false; clearCacheBtn.disabled=false;
      } else if (state==='error' || state==='cancelled'){
        startBtn.disabled=true; cancelBtn.disabled=true; dlBtn.disabled=true; resetBtn.disabled=false; clearCacheBtn.disabled=false;
      } else if (state==='preparing'){
        startBtn.disabled=true; cancelBtn.disabled=true; dlBtn.disabled=true; resetBtn.disabled=false; clearCacheBtn.disabled=false;
      } else {
        // reset state - disable all controls initially
        startBtn.disabled=true; cancelBtn.disabled=true; dlBtn.disabled=true; resetBtn.disabled=true; clearCacheBtn.disabled=false;
      }
    }

    startBtn.addEventListener('click', ()=> {
      if (!currentJob) return;
      setStatus('Starting transcription...');
      const payload = {
        model_size: modelSelect.value,
        options: {
          task: taskSelect.value,
          temperature: parseFloat(tempInput.value||'0'),
          beam_size: parseInt(beamInput.value||'5'),
          best_of: parseInt(bestOfInput.value||'5'),
          language: (langInput.value||'').trim() || undefined,
        }
      };
      fetch('/start/'+currentJob,{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)})
        .then(r=>r.json())
        .then(data=>{
          if (data.error){ setStatus(data.error,'error'); return; }
          enableControls('processing');
          progressBar.style.width='5%';
          pollStatus();
        })
        .catch(()=> setStatus('Start failed','error'));
    });

    cancelBtn.addEventListener('click', ()=>{
      if (!currentJob) return;
      fetch('/cancel/'+currentJob,{method:'POST'})
        .then(r=>r.json()).then(d=>{
          if (d.error){ setStatus(d.error,'error'); return; }
          enableControls('cancelled'); setStatus('Cancelled','error');
        }).catch(()=> setStatus('Cancel failed','error'));
    });

    dlBtn.addEventListener('click', ()=>{
      if (!currentJob) return;
      const url = '/download/'+currentJob;
      fetch(url).then(r=>{ if(!r.ok) throw new Error('Download failed'); return r.blob(); })
        .then(blob=>{
          const a=document.createElement('a');
          const u=URL.createObjectURL(blob);
          a.href=u; a.download='transcript.txt';
          document.body.appendChild(a); a.click(); a.remove();
          URL.revokeObjectURL(u);
          setStatus('Downloaded','ok');
        }).catch(err=> setStatus(err.message,'error'));
    });

    resetBtn.addEventListener('click', ()=>{
      resetUI(true);
    });

    clearCacheBtn.addEventListener('click', async ()=>{
      const originalText = clearCacheBtn.textContent;
      clearCacheBtn.disabled = true;
      clearCacheBtn.textContent = 'Clearing...';
      
      try {
        const response = await fetch('/clear-cache', { method: 'POST' });
        const data = await response.json();
        
        if (data.success) {
          setStatus(`✓ ${data.message} (${data.freed_memory_mb} MB freed)`, 'ok');
        } else {
          setStatus(`✗ Cache clear failed: ${data.error}`, 'error');
        }
      } catch (err) {
        setStatus(`✗ Cache clear error: ${err.message}`, 'error');
      } finally {
        clearCacheBtn.disabled = false;
        clearCacheBtn.textContent = originalText;
      }
    });

    function resetUI(clearMeta){
      currentJob=null; logOffset=0; progressBar.style.width='0%';
      if (clearMeta){ metaDiv.classList.add('hidden'); metaDiv.innerHTML=''; controls.classList.add('hidden'); logsWrap.classList.add('hidden'); logsEl.innerHTML=''; }
      enableControls('reset');
    }

    function pollStatus(){
      if (!currentJob) return;
      fetch('/status/'+currentJob)
        .then(r=>r.json())
        .then(data=>{
          if (data.error){ setStatus('Error: '+data.error,'error'); return; }
          const st=data.status; const metaStatus=document.getElementById('meta-status'); if(metaStatus) metaStatus.textContent=st;
          if (st==='preparing'){
            setStatus('Preparing audio ...');
            if (typeof data.progress_pct === 'number'){
              progressBar.style.width = data.progress_pct+'%';
            } else if (typeof data.prep_progress_pct === 'number') {
              progressBar.style.width = data.prep_progress_pct+'%';
            }
            if (typeof data.eta_seconds === 'number') updateEta(data.eta_seconds);
            enableControls('preparing');
            pollTimer=setTimeout(pollStatus, 1500);
          } else if (st==='processing'){
            setStatus('Transcribing ...');
            if (typeof data.progress_pct === 'number'){
              progressBar.style.width = data.progress_pct+'%';
            } else {
              const cur=parseInt(progressBar.style.width)||5; if(cur<94) progressBar.style.width=(cur+Math.random()*4)+'%';
            }
            if (typeof data.eta_seconds === 'number'){
              updateEta(data.eta_seconds);
            }
            enableControls('processing');
            pollTimer=setTimeout(pollStatus, 2000);
          } else if (st==='done'){
            progressBar.style.width='100%';
            setStatus('Completed','ok'); enableControls('done');
            clearEta();
          } else if (st==='error'){
            setStatus('Failed: '+(data.error||'unknown'),'error'); enableControls('error');
            clearEta();
          } else if (st==='cancelled'){
            setStatus('Cancelled','error'); enableControls('cancelled');
            clearEta();
          } else if (st==='queued'){
            setStatus('Queued ...');
            if (typeof data.eta_seconds === 'number') updateEta(data.eta_seconds);
            pollTimer=setTimeout(pollStatus,1500);
          } else if (st==='ready'){
            setStatus('Ready to start');
            if (typeof data.eta_seconds === 'number') updateEta(data.eta_seconds);
            enableControls('ready');
          }
        })
        .catch(()=>{ setStatus('Status polling error','error'); pollTimer=setTimeout(pollStatus,3000); });
    }

    let etaTimer=null; let lastEtaSeconds=null;
    function updateEta(seconds){
      lastEtaSeconds = seconds;
      const etaDiv=document.getElementById('eta');
      function render(){
        if (lastEtaSeconds==null){ etaDiv.textContent=''; return; }
        const s = Math.max(0, Math.round(lastEtaSeconds));
        const m = Math.floor(s/60); const sec = s%60;
        etaDiv.textContent = 'ETA: '+ (m>0? m+'m ':'') + sec + 's';
        lastEtaSeconds -= 1;
      }
      if (etaTimer) clearInterval(etaTimer);
      render();
      etaTimer=setInterval(()=>{ if(lastEtaSeconds<=0){ clearInterval(etaTimer); etaTimer=null; } else render(); },1000);
    }
    function clearEta(){ if(etaTimer) clearInterval(etaTimer); etaTimer=null; lastEtaSeconds=null; document.getElementById('eta').textContent=''; }

  function startLogPolling(){
      if (!currentJob) return;
      const run = () => {
        fetch('/logs/'+currentJob+'?since='+logOffset)
          .then(r=>r.json())
          .then(data=>{
            if (data.entries){
              for (const entry of data.entries){
                appendLog(entry);
              }
              logOffset = data.next;
            }
            logTimer=setTimeout(run, 1500);
          }).catch(()=> { logTimer=setTimeout(run,3000); });
      };
      run();
    }

    function appendLog(entry){
      const d=new Date(entry.ts*1000);
      const timeStr=d.toLocaleTimeString();
      const div=document.createElement('div');
      div.className='line';
      div.innerHTML = `<span class="ts">[${timeStr}]</span>${escapeHtml(entry.msg)}`;
      logsEl.appendChild(div);
      logsEl.scrollTop=logsEl.scrollHeight;
    }

    function escapeHtml(str){
      return str.replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));
    }

    // Jobs dashboard
    const jobsBoard = document.getElementById('jobs-board');
    const jobsTbody = document.getElementById('jobs-tbody');
    const refreshJobsBtn = document.getElementById('refresh-jobs');
    refreshJobsBtn.addEventListener('click', refreshJobs);
    function refreshJobs(){
      fetch('/jobs').then(r=>r.json()).then(rows=>{
        if (!Array.isArray(rows)) return;
        jobsTbody.innerHTML='';
        rows.slice(0,50).forEach(rw=>{
          const tr=document.createElement('tr');
          tr.style.cursor='pointer';
            tr.innerHTML = `<td style="padding:6px 10px; white-space:nowrap;"><code>${rw.id.slice(0,8)}</code></td>
            <td style="padding:6px 10px; max-width:180px; overflow:hidden; text-overflow:ellipsis;">${escapeHtml(rw.original_filename||'')}</td>
            <td style="padding:6px 10px;">${rw.model_size||''}</td>
            <td style="padding:6px 10px;">${rw.status}</td>
            <td style="padding:6px 10px;">${rw.progress_pct? Math.round(rw.progress_pct)+'%':''}</td>`;
          tr.addEventListener('click', ()=>{
            if (rw.id !== currentJob){
              currentJob = rw.id; logOffset=0; logsEl.innerHTML=''; pollStatus(); startLogPolling();
              setStatus('Attached to job '+rw.id);
            }
          });
          jobsTbody.appendChild(tr);
        });
        jobsBoard.classList.remove('hidden');
      }).catch(()=>{});
    }
    // initial load
    refreshJobs(); setInterval(refreshJobs, 10000);
  </script>
</body>
</html>